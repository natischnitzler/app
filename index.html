_code));saveCartToStorage();updateCartButton();renderSearchResults(searchResults);showToast(`‚úì ${familyProducts.length} productos agregados`)}
function removeAllFromFamily(family){const familyProducts=searchResults.filter(p=>(p.Parent_category||'Otros')===family);familyProducts.forEach(p=>cartItems.delete(p.Default_code));saveCartToStorage();updateCartButton();renderSearchResults(searchResults);showToast(`‚úì ${familyProducts.length} productos removidos`)}
function toggleCart(sku){if(cartItems.has(sku)){cartItems.delete(sku)}else{cartItems.add(sku);const btn=document.getElementById('cart-btn');btn.classList.add('pulse');setTimeout(()=>btn.classList.remove('pulse'),300)}saveCartToStorage();updateCartButton();if(currentMode==='search')renderSearchResults(searchResults)}
function saveCartToStorage(){localStorage.setItem('cart_items',JSON.stringify([...cartItems]))}
function loadCartFromStorage(){try{const saved=localStorage.getItem('cart_items');if(saved){const items=JSON.parse(saved);cartItems=new Set(items);updateCartButton()}}catch(err){console.error('Error loading cart:',err)}}
function updateCartButton(){const btn=document.getElementById('cart-btn'),count=document.getElementById('cart-count');if(cartItems.size>0){btn.classList.add('show');count.textContent=`${cartItems.size} producto${cartItems.size>1?'s':''}`}else{btn.classList.remove('show')}}
function openCart(){const modal=document.getElementById('cart-modal'),itemsContainer=document.getElementById('cart-items'),nameInput=document.getElementById('custom-catalog-name');nameInput.value='';if(cartItems.size===0){itemsContainer.innerHTML='<div class="loading-state"><div style="padding:40px 20px">üõí<br><br>Canasta vac√≠a</div></div>';document.getElementById('generate-cart-pdf').disabled=true}else{let totalPrice=0,html='';cartItems.forEach(sku=>{const p=allProducts.find(prod=>prod.Default_code===sku);if(!p)return;const price=p.Price||0;totalPrice+=price;const priceFormatted=formatPrice(price);html+=`<div class="cart-item"><button class="remove-item" onclick="toggleCart('${sku}');openCart()">√ó</button><div class="cart-item-img">üì¶</div><div class="product-info" style="flex:1;min-width:0"><div class="product-code">${p.Default_code}</div><div class="product-name">${p.Name||'Sin nombre'}</div></div><div class="product-price">${priceFormatted}</div></div>`});const totalFormatted=formatPrice(totalPrice);itemsContainer.innerHTML=`<div class="cart-summary"><span style="font-weight:600;color:#666">Total (sin IVA)</span><span style="font-size:18px;font-weight:700;color:#333">${totalFormatted}</span></div><button class="clear-cart-btn" onclick="clearCart()">üóëÔ∏è Limpiar canasta</button>${html}`;document.getElementById('generate-cart-pdf').disabled=false}modal.classList.add('show')}
function clearCart(){if(!confirm('¬øLimpiar toda la canasta?'))return;cartItems.clear();saveCartToStorage();updateCartButton();closeCart();if(currentMode==='search')performSearch()}
function closeCart(){document.getElementById('cart-modal').classList.remove('show')}
async function generateCartPDF(){const name=document.getElementById('custom-catalog-name').value.trim()||'Cat√°logo personalizado';if(cartItems.size===0){showToast('Canasta vac√≠a');return}const products=allProducts.filter(p=>cartItems.has(p.Default_code));closeCart();showToast('Generando PDF...');try{await generatePDF(name,products);showToast('‚úì PDF descargado')}catch(err){console.error('PDF error:',err);showToast('Error al generar PDF')}}
function getAvailableFilters(products){const filters={generos:{},colores:{},tamanos:{},resistencias:{},familias:{}};products.forEach(p=>{const c=caracteristicas[p.Default_code];if(c){if(c.genero)filters.generos[c.genero]=(filters.generos[c.genero]||0)+1;if(c.color)filters.colores[c.color]=(filters.colores[c.color]||0)+1;if(c.tamano_esfera)filters.tamanos[c.tamano_esfera]=(filters.tamanos[c.tamano_esfera]||0)+1;if(c.resistencia_agua)filters.resistencias[c.resistencia_agua]=(filters.resistencias[c.resistencia_agua]||0)+1}const family=p.Parent_category||'Otros';filters.familias[family]=(filters.familias[family]||0)+1});return filters}
function renderFilters(){const products=currentMode==='search'?searchResults.length>0?searchResults:allProducts:currentCatalog?currentCatalog.products:[];const filters=getAvailableFilters(products),content=document.getElementById('filters-content');let html='';if(currentMode==='search'&&Object.keys(filters.familias).length>0){html+=`<div class="filter-section"><div class="filter-section-title">Familia</div>`;Object.entries(filters.familias).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([f,count])=>{const checked=activeFilters.familias.includes(f)?'checked':'';html+=`<div class="filter-option"><input type="checkbox" id="fam-${f}" ${checked} onchange="toggleMultiFilter('familias','${f}')"><label for="fam-${f}">${f}</label><span class="filter-option-count">(${count})</span></div>`});html+=`</div>`}if(Object.keys(filters.generos).length>0){html+=`<div class="filter-section"><div class="filter-section-title">G√©nero</div>`;Object.entries(filters.generos).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([g,count])=>{const checked=activeFilters.generos.includes(g)?'checked':'';html+=`<div class="filter-option"><input type="checkbox" id="gen-${g}" ${checked} onchange="toggleMultiFilter('generos','${g}')"><label for="gen-${g}">${g}</label><span class="filter-option-count">(${count})</span></div>`});html+=`</div>`}if(Object.keys(filters.colores).length>0){html+=`<div class="filter-section"><div class="filter-section-title">Color</div>`;Object.entries(filters.colores).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([c,count])=>{const checked=activeFilters.colores.includes(c)?'checked':'';html+=`<div class="filter-option"><input type="checkbox" id="col-${c}" ${checked} onchange="toggleMultiFilter('colores','${c}')"><label for="col-${c}">${c}</label><span class="filter-option-count">(${count})</span></div>`});html+=`</div>`}if(Object.keys(filters.tamanos).length>0){html+=`<div class="filter-section"><div class="filter-section-title">Tama√±o esfera</div>`;Object.entries(filters.tamanos).sort((a,b)=>a[0]-b[0]).forEach(([t,count])=>{const checked=activeFilters.tamanos.includes(parseInt(t))?'checked':'';html+=`<div class="filter-option"><input type="checkbox" id="tam-${t}" ${checked} onchange="toggleMultiFilter('tamanos',${t})"><label for="tam-${t}">${t}mm</label><span class="filter-option-count">(${count})</span></div>`});html+=`</div>`}if(Object.keys(filters.resistencias).length>0){html+=`<div class="filter-section"><div class="filter-section-title">Resistencia al agua</div>`;Object.entries(filters.resistencias).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([r,count])=>{const checked=activeFilters.resistencias.includes(r)?'checked':'';html+=`<div class="filter-option"><input type="checkbox" id="res-${r}" ${checked} onchange="toggleMultiFilter('resistencias','${r}')"><label for="res-${r}">${r}</label><span class="filter-option-count">(${count})</span></div>`});html+=`</div>`}content.innerHTML=html}
function toggleFilters(){const sidebar=document.getElementById('filters-sidebar'),overlay=document.getElementById('filters-overlay');if(!sidebar.classList.contains('open')){renderFilters()}sidebar.classList.toggle('open');overlay.classList.toggle('show')}
function toggleMultiFilter(type,value){const idx=activeFilters[type].indexOf(value);if(idx>-1){activeFilters[type].splice(idx,1)}else{activeFilters[type].push(value)}if(currentMode==='catalogs'){applyFilters()}else{performSearch()}updateFilterCount()}
function clearAllFilters(){activeFilters={generos:[],colores:[],tamanos:[],resistencias:[],familias:[]};if(currentMode==='catalogs'){applyFilters()}else{performSearch()}renderFilters();updateFilterCount()}
function updateFilterCount(){const total=activeFilters.generos.length+activeFilters.colores.length+activeFilters.tamanos.length+activeFilters.resistencias.length+activeFilters.familias.length,badge1=document.getElementById('filter-count'),badge2=document.getElementById('search-filter-count');if(total>0){if(badge1){badge1.textContent=total;badge1.style.display='inline-block'}if(badge2){badge2.textContent=total;badge2.style.display='inline-block'}}else{if(badge1)badge1.style.display='none';if(badge2)badge2.style.display='none'}}
function navigateCatalog(direction){const newIndex=currentCatalogIndex+direction;if(newIndex<0||newIndex>=catalogList.length)return;const newCatalogName=catalogList[newIndex];openCatalog(encodeURIComponent(newCatalogName))}
function updateProductCount(){const total=currentCatalog.products.length,showing=filteredProducts.length,label=document.getElementById('product-count-label');if(showing<total){label.textContent=`Mostrando ${showing} de ${total} productos`}else{label.textContent=`${total} productos`}}
function applyFilters(){if(!currentCatalog)return;let filtered=currentCatalog.products;if(activeFilters.generos.length>0)filtered=filtered.filter(p=>{const c=caracteristicas[p.Default_code];return c&&activeFilters.generos.includes(c.genero)});if(activeFilters.colores.length>0)filtered=filtered.filter(p=>{const c=caracteristicas[p.Default_code];return c&&activeFilters.colores.includes(c.color)});if(activeFilters.tamanos.length>0)filtered=filtered.filter(p=>{const c=caracteristicas[p.Default_code];return c&&activeFilters.tamanos.includes(c.tamano_esfera)});if(activeFilters.resistencias.length>0)filtered=filtered.filter(p=>{const c=caracteristicas[p.Default_code];return c&&activeFilters.resistencias.includes(c.resistencia_agua)});filteredProducts=filtered;updateProductCount();renderCatalogProducts(filtered)}
function openCatalog(n){const name=decodeURIComponent(n);currentCatalog=catalogs[name];if(!currentCatalog)return;currentCatalogIndex=catalogList.indexOf(name);currentMode='catalogs';activeFilters={generos:[],colores:[],tamanos:[],resistencias:[],familias:[]};selectedProducts.clear();filteredProducts=currentCatalog.products;document.getElementById('pdf-title-header').textContent=name;updateProductCount();updateFilterCount();renderCatalogProducts(currentCatalog.products);showScreen('pdf-viewer')}
function renderCatalogProducts(products){const today=new Date().toLocaleDateString('es-CL',{day:'2-digit',month:'2-digit',year:'numeric'}),photoBase=localStorage.getItem('photo_base_url')||'';let html=`<div class="pdf-page-header"><div class="pdf-header-left"><div class="contact-info"><div class="contact-item">üìû 9 6292 9654</div><div class="contact-item">‚úâÔ∏è ventas@temponovo.cl</div></div><div class="contact-info"><div class="contact-item">üìû 2 2229 3138</div><div class="contact-item">üìç Las Carmelitas 51, Las Condes</div></div></div><img src="https://www.temponovo.cl/asset/img/temponovo-logo-color.svg" class="pdf-page-logo"></div><div class="pdf-page-title-bar"><div class="pdf-page-title">${currentCatalog.name}</div><div class="pdf-page-date">${today}</div></div>`;if(selectedProducts.size>0){html+=`<div style="background:#27ae60;color:white;padding:12px 20px;display:flex;align-items:center;justify-content:space-between"><span>${selectedProducts.size} producto${selectedProducts.size>1?'s':''} seleccionado${selectedProducts.size>1?'s':''}</span><button onclick="generateSelectedPDF()" style="background:white;color:#27ae60;border:none;padding:8px 16px;border-radius:6px;font-weight:600;cursor:pointer">Generar PDF</button></div>`}html+=`<div class="pdf-products">`;products.forEach(p=>{const price=formatPrice(p.Price||0),stock=p.Stock||0,stockDisplay=stock>100?'100+':stock;let stockClass='high';if(stock<10)stockClass='low';else if(stock<15)stockClass='medium';const imgTag=photoBase?`<img src="${photoBase}/${p.Default_code}.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt="${p.Name}">`:'',caract=caracteristicas[p.Default_code];let featuresHtml='';if(caract){featuresHtml='<div class="product-features">';if(caract.genero)featuresHtml+=`<div class="feature-item"><span class="feature-label">G√©nero:</span> <span class="feature-value">${caract.genero}</span></div>`;if(caract.color)featuresHtml+=`<div class="feature-item"><span class="feature-label">Color:</span> <span class="feature-value">${caract.color}</span></div>`;if(caract.tamano_esfera)featuresHtml+=`<div class="feature-item"><span class="feature-label">Tama√±o:</span> <span class="feature-value">${caract.tamano_esfera}mm</span></div>`;if(caract.resistencia_agua)featuresHtml+=`<div class="feature-item"><span class="feature-label">Resist:</span> <span class="feature-value">${caract.resistencia_agua}</span></div>`;featuresHtml+='</div>'}const isSelected=selectedProducts.has(p.Default_code);html+=`<div class="pdf-product" style="position:relative"><input type="checkbox" ${isSelected?'checked':''} onchange="toggleProductSelection('${p.Default_code}')" style="position:absolute;top:10px;left:10px;width:20px;height:20px;cursor:pointer;z-index:10;accent-color:#27ae60"><div class="pdf-product-img-wrap">${imgTag}<div class="emoji" style="${imgTag?'display:none':'display:flex'}">üì¶</div><div class="stock-corner ${stockClass}">${stockDisplay}</div></div><div class="pdf-product-info"><div class="pdf-product-code">${p.Default_code||''}</div><div class="pdf-product-name">${p.Name||'Sin nombre'}</div><div class="pdf-product-price">${price} <span>+ IVA</span></div>${featuresHtml}</div></div>`});html+=`</div><div class="pdf-footer">üìû 9 6292 9654 ¬∑ 2 2229 3138 | ‚úâÔ∏è ventas@temponovo.cl | üìç Las Carmelitas 51, Las Condes<br>Actualizado: ${today}</div>`;document.getElementById('pdf-content').innerHTML=html}
function toggleProductSelection(sku){if(selectedProducts.has(sku)){selectedProducts.delete(sku)}else{selectedProducts.add(sku)}renderCatalogProducts(filteredProducts)}
async function generateSelectedPDF(){if(selectedProducts.size===0){showToast('Selecciona al menos un producto');return}const selectedList=filteredProducts.filter(p=>selectedProducts.has(p.Default_code));showToast('Generando PDF...');try{await generatePDF(currentCatalog.name+' (Selecci√≥n)',selectedList);showToast('‚úì PDF descargado')}catch(err){console.error('PDF error:',err);showToast('Error al generar PDF')}}
function formatPrice(p){if(!p)return'$0';return'$'+Math.round(p).toLocaleString('es-CL')}
async function generatePDF(catName,products){const{jsPDF}=window.jspdf,tempDiv=document.createElement('div');tempDiv.style.position='absolute';tempDiv.style.left='-9999px';tempDiv.className='pdf-page';const today=new Date().toLocaleDateString('es-CL',{day:'2-digit',month:'2-digit',year:'numeric'});let html=`<div class="pdf-page-header"><div class="pdf-header-left"><div class="contact-info"><div class="contact-item">üìû 9 6292 9654</div><div class="contact-item">‚úâÔ∏è ventas@temponovo.cl</div></div></div><img src="https://www.temponovo.cl/asset/img/temponovo-logo-color.svg" class="pdf-page-logo"></div><div class="pdf-page-title-bar"><div class="pdf-page-title">${catName}</div><div class="pdf-page-date">${today}</div></div><div class="pdf-products">`;products.forEach(p=>{const price=formatPrice(p.Price||0),stock=p.Stock||0,stockDisplay=stock>100?'100+':stock;let stockClass=stock<10?'low':stock<15?'medium':'high';html+=`<div class="pdf-product"><div class="pdf-product-img-wrap"><div class="emoji">üì¶</div><div class="stock-corner ${stockClass}">${stockDisplay}</div></div><div class="pdf-product-info"><div class="pdf-product-code">${p.Default_code||''}</div><div class="pdf-product-name">${p.Name||'Sin nombre'}</div><div class="pdf-product-price">${price} <span>+ IVA</span></div></div></div>`});html+=`</div>`;tempDiv.innerHTML=html;document.body.appendChild(tempDiv);const canvas=await html2canvas(tempDiv,{scale:1.5,logging:false}),imgData=canvas.toDataURL('image/jpeg',0.9),pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'}),imgWidth=210,imgHeight=(canvas.height*imgWidth)/canvas.width;pdf.addImage(imgData,'JPEG',0,0,imgWidth,imgHeight);const filename=`${catName.replace(/[^a-z0-9]/gi,'_')}.pdf`;pdf.save(filename);document.body.removeChild(tempDiv)}
async function shareCatalogPDF(){if(!currentCatalog)return;showToast('Generando PDF...');try{await generatePDF(currentCatalog.name,filteredProducts);showToast('‚úì PDF descargado')}catch(err){console.error('PDF error:',err);showToast('Error al generar PDF')}}
async function downloadAllCatalogs(){if(Object.keys(catalogs).length===0){showToast('No hay cat√°logos disponibles');return}showToast(`Generando ${Object.keys(catalogs).length} PDFs...`);let completed=0;for(const[catName,catalog]of Object.entries(catalogs)){try{await generatePDF(catName,catalog.products);completed++;await new Promise(res=>setTimeout(res,500))}catch(err){console.error(`Error generando ${catName}:`,err)}}showToast(`‚úì ${completed} PDFs descargados`)}
function showAdminPanel(){const url=prompt('URL base de fotos en Google Drive:',localStorage.getItem('photo_base_url')||'');if(url!==null){localStorage.setItem('photo_base_url',url.trim());showToast('‚úì URL de fotos guardada');if(currentCatalog){openCatalog(encodeURIComponent(currentCatalog.name))}}}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');window.scrollTo(0,0)}
function goToWelcome(){activeFilters={generos:[],colores:[],tamanos:[],resistencias:[],familias:[]};updateFilterCount();showScreen('welcome')}
function goToCatalogs(){currentMode='catalogs';showScreen('home')}
function goToSearch(){currentMode='search';activeFilters={generos:[],colores:[],tamanos:[],resistencias:[],familias:[]};document.getElementById('search-input').value='';updateFilterCount();showScreen('search')}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
async function init(){loadCartFromStorage();await fetchCaracteristicas();allProducts=await loadProducts();if(allProducts.length>0){buildCatalogs();setSyncStatus('Offline');const lastSync=await getLastSync();updateLastSyncDisplay(lastSync)}const lastSync=await getLastSync();const needsUpdate=Date.now()-lastSync>UPDATE_INTERVAL;if(navigator.onLine&&(needsUpdate||allProducts.length===0)){const success=await fetchProducts();if(success)buildCatalogs()}window.addEventListener('online',async()=>{showToast('Conexi√≥n restaurada');await fetchProducts();buildCatalogs()})}
init();
</script>
</body>
</html>
