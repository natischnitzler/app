<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Temponovo</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Roboto',sans-serif;background:#f5f5f5;color:#333}

/* ANIMATIONS */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

.screen{display:none;animation:fadeIn 0.3s ease}
.screen.active{display:block}

.family-group{animation:slideUp 0.3s ease}
.product-item{transition:all 0.2s ease}
.product-item:hover{transform:translateX(4px)}

.cart-btn{animation:slideUp 0.3s ease}
.cart-btn.pulse{animation:pulse 0.3s ease}

.modal{animation:fadeIn 0.2s ease}
.modal-content{animation:slideUp 0.3s ease}

.header{background:#2c3e50;padding:20px;text-align:center;position:relative}
.logo{height:45px;margin-bottom:16px}
.header-stats{display:flex;justify-content:center;gap:40px;margin-bottom:12px}
.stat-item{display:flex;flex-direction:column;align-items:center}
.stat-number{font-size:28px;font-weight:700;color:white}
.stat-label{font-size:10px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:0.5px;margin-top:2px}
.sync-status{font-size:11px;color:rgba(255,255,255,0.8);display:flex;align-items:center;justify-content:center;gap:6px}
.sync-dot{width:8px;height:8px;border-radius:50%;background:#4caf50}
.last-update{position:absolute;top:12px;right:12px;font-size:9px;color:rgba(255,255,255,0.6);text-align:right}

.screen{display:none}
.screen.active{display:block}

/* WELCOME SCREEN */
.welcome-content{padding:40px 20px;max-width:500px;margin:0 auto}
.mode-buttons{display:grid;gap:20px;margin-top:40px}
.mode-btn{background:white;border:2px solid #e0e0e0;border-radius:16px;padding:32px 24px;cursor:pointer;transition:all 0.2s;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.mode-btn:hover{border-color:#2c3e50;box-shadow:0 4px 16px rgba(0,0,0,0.12)}
.mode-btn:active{transform:scale(0.98)}
.mode-icon{font-size:48px;margin-bottom:16px}
.mode-title{font-size:20px;font-weight:600;color:#333;margin-bottom:8px}
.mode-desc{font-size:13px;color:#666;line-height:1.5}

/* HOME CATALOGS */
.home-content{padding:16px;padding-bottom:80px}
.update-now-btn{background:#27ae60;color:white;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:600;width:100%;margin-bottom:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.update-now-btn:active{opacity:0.8}
.download-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.download-btn{background:#2c3e50;color:white;border:none;padding:14px 16px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s}
.download-btn:active{opacity:0.8}
.download-btn:disabled{background:#95a5a6;cursor:not-allowed;opacity:0.6}
.download-btn.has-selection{background:#27ae60}

.category-accordion{background:white;border-radius:12px;margin-bottom:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
.category-header{background:#2c3e50;color:white;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.category-header:active{opacity:0.9}
.category-left{display:flex;align-items:center;gap:12px;flex:1}
.category-icon{font-size:24px}
.category-title{font-size:16px;font-weight:600}
.category-count{font-size:13px;background:rgba(255,255,255,0.25);padding:4px 12px;border-radius:12px;margin-right:8px}
.chevron-icon{font-size:20px;transition:transform 0.3s}
.category-accordion.open .chevron-icon{transform:rotate(90deg)}
.category-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease}
.category-accordion.open .category-content{max-height:3000px}

.catalog-list{background:#fafafa}
.catalog-item{padding:12px 16px;border-bottom:1px solid #e8e8e8;display:flex;align-items:center;gap:12px}
.catalog-item:last-child{border-bottom:none}
.catalog-checkbox{width:20px;height:20px;cursor:pointer;accent-color:#2c3e50;flex-shrink:0}
.catalog-info{flex:1;cursor:pointer;min-width:0}
.catalog-name{font-size:15px;font-weight:500;color:#333;margin-bottom:3px}
.catalog-meta{font-size:12px;color:#999}

/* SEARCH */
.search-bar{background:white;padding:16px;border-bottom:1px solid #e0e0e0;position:sticky;top:0;z-index:99}
.search-input{width:100%;padding:12px 16px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;font-family:'Roboto',sans-serif}
.search-input:focus{outline:none;border-color:#2c3e50}
.search-results{padding:16px}
.family-group{background:white;border-radius:12px;margin-bottom:16px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
.family-header{background:#2c3e50;color:white;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
.family-title{font-size:14px;font-weight:600;flex:1}
.add-all-btn{background:rgba(255,255,255,0.2);color:white;border:none;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer}
.add-all-btn:active{background:rgba(255,255,255,0.3)}
.product-list{padding:12px}
.product-item{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid #f0f0f0;background:#fafafa;margin-bottom:8px;border-radius:8px}
.product-item:last-child{border-bottom:none;margin-bottom:0}
.product-item:active{background:#f0f0f0}
.product-checkbox{width:20px;height:20px;accent-color:#27ae60;cursor:pointer;flex-shrink:0}
.product-item-img{width:50px;height:50px;background:#fff;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:28px;border:1px solid #e0e0e0;flex-shrink:0}
.product-info{flex:1;min-width:0}
.product-code{font-size:12px;font-weight:700;color:#333;margin-bottom:2px}
.product-name{font-size:11px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.product-price{font-size:13px;font-weight:600;color:#333;flex-shrink:0}

/* PDF VIEWER */
.pdf-header{background:white;border-bottom:1px solid #e0e0e0;padding:12px 20px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
.back-btn{background:none;border:none;color:#2c3e50;font-size:28px;cursor:pointer;padding:0;line-height:1;font-family:Arial;transition:transform 0.2s}
.back-btn:active{transform:scale(0.9)}
.pdf-title{flex:1;font-size:16px;font-weight:500;color:#333}
.breadcrumb{font-size:11px;color:#999;margin-top:2px}
.breadcrumb-separator{margin:0 6px}
.filter-toggle-btn{background:#2c3e50;color:white;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:6px;margin-right:8px}
.filter-toggle-btn:active{opacity:0.8}
.filter-count{background:#27ae60;color:white;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700}
.share-btn{background:#2c3e50;color:white;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:6px}
.share-btn:active{opacity:0.8}

.filters-sidebar{position:fixed;top:0;right:-300px;width:280px;height:100vh;background:white;box-shadow:-2px 0 10px rgba(0,0,0,0.1);z-index:200;transition:right 0.3s;overflow-y:auto}
.filters-sidebar.open{right:0}
.filters-header{background:#2c3e50;color:white;padding:16px;display:flex;align-items:center;justify-content:space-between}
.filters-title{font-size:16px;font-weight:600}
.close-filters{background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:0}
.filter-section{padding:16px;border-bottom:1px solid #e8e8e8}
.filter-section-title{font-size:14px;font-weight:600;color:#333;margin-bottom:12px}
.filter-option{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.filter-option input{width:18px;height:18px;cursor:pointer;accent-color:#2c3e50}
.filter-option label{font-size:13px;color:#666;cursor:pointer;flex:1}
.filter-option-count{font-size:11px;color:#999}
.clear-filters-btn{background:#e74c3c;color:white;border:none;padding:12px;width:calc(100% - 32px);margin:16px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer}
.clear-filters-btn:active{opacity:0.8}
.filters-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:199;display:none}
.filters-overlay.show{display:block}

.pdf-page{background:white;max-width:100%;margin:0}
.pdf-page-header{background:white;padding:20px;display:flex;justify-content:space-between;align-items:flex-start;border-bottom:1px solid #e0e0e0}
.pdf-header-left{display:flex;flex-direction:column;gap:8px}
.contact-info{display:flex;align-items:center;gap:12px;font-size:12px;color:#666}
.contact-item{display:flex;align-items:center;gap:4px}
.pdf-page-logo{height:45px}
.pdf-page-title-bar{background:#2c3e50;padding:16px 20px;color:white}
.pdf-page-title{font-size:20px;font-weight:700}
.pdf-page-date{font-size:12px;opacity:0.9;margin-top:4px}
.pdf-products{padding:20px;display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
.pdf-product{background:white;border:1px solid #e8e8e8;border-radius:12px;overflow:hidden;transition:all 0.2s}
.pdf-product:hover{box-shadow:0 4px 16px rgba(0,0,0,0.12);transform:translateY(-2px)}
.pdf-product-img-wrap{width:100%;aspect-ratio:1;background:#fafafa;display:flex;align-items:center;justify-content:center;border-bottom:1px solid #f0f0f0;padding:16px;position:relative}
.pdf-product-img-wrap img{width:100%;height:100%;object-fit:contain}
.pdf-product-img-wrap .emoji{font-size:64px}
.stock-corner{position:absolute;top:10px;right:10px;min-width:32px;height:32px;padding:0 6px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
.stock-corner.high{background:#4caf50}
.stock-corner.medium{background:#ff9800}
.stock-corner.low{background:#f44336}
.pdf-product-info{padding:14px 12px;text-align:center}
.pdf-product-code{font-size:13px;font-weight:700;color:#000;margin-bottom:6px;letter-spacing:0.3px}
.pdf-product-name{font-size:11px;color:#666;line-height:1.3;margin-bottom:6px;min-height:28px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.pdf-product-price{font-size:16px;color:#333;font-weight:700;margin-bottom:8px}
.pdf-product-price span{font-size:11px;font-weight:400;color:#999}
.product-features{font-size:10px;color:#555;line-height:1.5;margin-top:8px;padding-top:8px;padding-left:10px;border-top:1px solid #f0f0f0;border-left:3px solid #2c3e50;text-align:left}
.feature-item{margin-bottom:3px}
.feature-label{font-weight:600;color:#333}
.feature-value{color:#666}
.pdf-footer{background:#f8f8f8;padding:16px 20px;border-top:1px solid #e0e0e0;text-align:center;font-size:11px;color:#666;line-height:1.6}

@media (max-width:768px){
  .pdf-products{grid-template-columns:repeat(2,1fr);gap:14px;padding:16px}
  .contact-info{flex-direction:column;align-items:flex-start;gap:6px}
  .header-stats{gap:28px}
  .stat-number{font-size:24px}
}

.loading-state{text-align:center;padding:60px 20px;color:#999}
.spinner{width:40px;height:40px;border:3px solid #f0f0f0;border-top-color:#2c3e50;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}

.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#323232;color:white;padding:12px 24px;border-radius:8px;font-size:14px;opacity:0;pointer-events:none;transition:opacity 0.3s;z-index:9999}
.toast.show{opacity:1}

.admin-btn{position:fixed;bottom:20px;right:20px;width:56px;height:56px;background:#2c3e50;color:white;border-radius:50%;border:none;font-size:24px;cursor:pointer;box-shadow:0 4px 12px rgba(44,62,80,0.4);z-index:50}
.admin-btn:active{transform:scale(0.95)}

.cart-btn{position:fixed;bottom:90px;right:20px;background:#27ae60;color:white;border:none;padding:16px 20px;border-radius:30px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(39,174,96,0.4);z-index:50;display:none;align-items:center;gap:8px}
.cart-btn.show{display:flex}
.cart-btn:active{transform:scale(0.95)}

.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:300;display:none;align-items:center;justify-content:center;padding:20px}
.modal.show{display:flex}
.modal-content{background:white;border-radius:16px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto}
.modal-header{background:#2c3e50;color:white;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-radius:16px 16px 0 0}
.modal-title{font-size:18px;font-weight:600}
.modal-close{background:none;border:none;color:white;font-size:28px;cursor:pointer;padding:0}
.modal-body{padding:20px}
.catalog-name-input{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;margin-bottom:16px;font-family:'Roboto',sans-serif}
.catalog-name-input:focus{outline:none;border-color:#2c3e50}
.cart-items{margin-bottom:20px;max-height:400px;overflow-y:auto}
.cart-item{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid #f0f0f0;background:#fafafa;margin-bottom:8px;border-radius:8px}
.cart-item:last-child{border-bottom:none}
.remove-item{background:#e74c3c;color:white;border:none;width:28px;height:28px;border-radius:50%;font-size:18px;cursor:pointer;line-height:1;flex-shrink:0}
.remove-item:active{transform:scale(0.9)}
.cart-item-img{width:60px;height:60px;background:#fff;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:32px;border:1px solid #e0e0e0}
.cart-summary{background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
.clear-cart-btn{background:#95a5a6;color:white;border:none;padding:10px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;margin-bottom:12px;width:100%}
.clear-cart-btn:active{opacity:0.8}
.generate-pdf-btn{background:#27ae60;color:white;border:none;padding:14px;width:100%;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer}
.generate-pdf-btn:active{opacity:0.8}
.generate-pdf-btn:disabled{background:#95a5a6;cursor:not-allowed}
</style>
</head>
<body>

<!-- WELCOME -->
<div id="welcome" class="screen active">
  <div class="header">
    <img src="https://www.temponovo.cl/asset/img/temponovo-logo-color.svg" alt="Temponovo" class="logo">
    <div class="header-stats">
      <div class="stat-item">
        <div class="stat-number" id="total-catalogs-welcome">0</div>
        <div class="stat-label">Cat√°logos</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="total-products-welcome">0</div>
        <div class="stat-label">Productos</div>
      </div>
    </div>
    <div class="sync-status">
      <div class="sync-dot"></div>
      <span id="sync-label-welcome">Cargando...</span>
    </div>
  </div>
  <div class="welcome-content">
    <div class="mode-buttons">
      <div class="mode-btn" onclick="goToCatalogs()">
        <div class="mode-icon">üìö</div>
        <div class="mode-title">Cat√°logos</div>
        <div class="mode-desc">Navega por familias y categor√≠as organizadas</div>
      </div>
      <div class="mode-btn" onclick="goToSearch()">
        <div class="mode-icon">üîç</div>
        <div class="mode-title">Buscador</div>
        <div class="mode-desc">Busca productos por c√≥digo y crea cat√°logos personalizados</div>
      </div>
    </div>
  </div>
  <button class="admin-btn" onclick="showAdminPanel()">‚öôÔ∏è</button>
</div>

<!-- HOME CATALOGS -->
<div id="home" class="screen">
  <div class="header">
    <div class="last-update" id="last-update-display">√öltima actualizaci√≥n: --</div>
    <img src="https://www.temponovo.cl/asset/img/temponovo-logo-color.svg" alt="Temponovo" class="logo">
    <div class="header-stats">
      <div class="stat-item">
        <div class="stat-number" id="total-catalogs">0</div>
        <div class="stat-label">Cat√°logos</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="total-products">0</div>
        <div class="stat-label">Productos</div>
      </div>
    </div>
    <div class="sync-status">
      <div class="sync-dot"></div>
      <span id="sync-label">Cargando...</span>
    </div>
  </div>
  
  <div class="home-content">
    <button class="update-now-btn" onclick="forceUpdate()">
      <span>üîÑ</span>
      <span>Actualizar ahora</span>
    </button>
    
    <div class="download-buttons">
      <button class="download-btn" onclick="goToWelcome()">
        <span>üîç</span>
        <span>Buscador</span>
      </button>
      <button class="download-btn" onclick="downloadAllCatalogs()">
        <span>üì¶</span>
        <span>Todos</span>
      </button>
    </div>
    
    <div id="home-content-inner">
      <div class="loading-state">
        <div class="spinner"></div>
        <div>Sincronizando...</div>
      </div>
    </div>
  </div>
  
  <button class="admin-btn" onclick="showAdminPanel()">‚öôÔ∏è</button>
</div>

<!-- SEARCH -->
<div id="search" class="screen">
  <div class="header">
    <img src="https://www.temponovo.cl/asset/img/temponovo-logo-color.svg" alt="Temponovo" class="logo" style="height:35px">
  </div>
  <div class="pdf-header" style="top:0">
    <button class="back-btn" onclick="goToWelcome()">‚Äπ</button>
    <div class="pdf-title">
      <div>Buscador</div>
      <div class="breadcrumb">Inicio <span class="breadcrumb-separator">‚Ä∫</span> Buscador</div>
    </div>
    <button class="filter-toggle-btn" onclick="toggleFilters()">
      <span>‚öô</span>
      <span>Filtros</span>
      <span class="filter-count" id="search-filter-count" style="display:none">0</span>
    </button>
  </div>
  <div class="search-bar">
    <input type="text" class="search-input" placeholder="Buscar por c√≥digo o nombre..." id="search-input" oninput="performSearch()">
  </div>
  <div class="search-results" id="search-results">
    <div class="loading-state">
      <div style="font-size:48px;margin-bottom:12px">üîç</div>
      <div>Escribe un c√≥digo para buscar</div>
    </div>
  </div>
  <button class="cart-btn" id="cart-btn" onclick="openCart()">
    <span>üõí</span>
    <span id="cart-count">0 productos</span>
  </button>
</div>

<!-- PDF VIEWER -->
<div id="pdf-viewer" class="screen">
  <div class="pdf-header">
    <button class="back-btn" onclick="goToCatalogs()">‚Äπ</button>
    <button class="back-btn" onclick="navigateCatalog(-1)" style="margin-left:8px">‚Äπ‚Äπ</button>
    <div class="pdf-title">
      <div id="pdf-title-header"></div>
      <div class="breadcrumb">Inicio <span class="breadcrumb-separator">‚Ä∫</span> Cat√°logos <span class="breadcrumb-separator">‚Ä∫</span> <span id="breadcrumb-catalog"></span></div>
      <div style="font-size:11px;color:#999;margin-top:2px" id="product-count-label"></div>
    </div>
    <button class="back-btn" onclick="navigateCatalog(1)" style="margin-right:8px">‚Ä∫‚Ä∫</button>
    <button class="filter-toggle-btn" onclick="toggleFilters()">
      <span>‚öô</span>
      <span>Filtros</span>
      <span class="filter-count" id="filter-count" style="display:none">0</span>
    </button>
    <button class="share-btn" onclick="shareCatalogPDF()">
      <span>üìÑ</span>
      <span>PDF</span>
    </button>
  </div>
  <div id="pdf-content" class="pdf-page"></div>
</div>

<!-- FILTERS SIDEBAR -->
<div class="filters-overlay" id="filters-overlay" onclick="toggleFilters()"></div>
<div class="filters-sidebar" id="filters-sidebar">
  <div class="filters-header">
    <div class="filters-title">Filtros</div>
    <button class="close-filters" onclick="toggleFilters()">√ó</button>
  </div>
  <div id="filters-content"></div>
  <button class="clear-filters-btn" onclick="clearAllFilters()">Limpiar filtros</button>
</div>

<!-- CART MODAL -->
<div class="modal" id="cart-modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Canasta</div>
      <button class="modal-close" onclick="closeCart()">√ó</button>
    </div>
    <div class="modal-body">
      <input type="text" class="catalog-name-input" placeholder="Nombre del cat√°logo" id="custom-catalog-name">
      <div class="cart-items" id="cart-items"></div>
      <button class="generate-pdf-btn" onclick="generateCartPDF()" id="generate-cart-pdf">Generar PDF</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API_URL='https://temponovo-api.onrender.com/api/stock';
const CARACT_URL='https://temponovo-api.onrender.com/api/caracteristicas';
const UPDATE_INTERVAL=24*60*60*1000;
const DB_NAME='temponovo_catalogs';

let allProducts=[];
let catalogs={};
let catalogsByCategory={};
let currentCatalog=null;
let currentCatalogIndex=0;
let catalogList=[];
let selectedCatalogs=new Set();
let caracteristicas={};
let activeFilters={generos:[],colores:[],tamanos:[],resistencias:[],familias:[]};
let filteredProducts=[];
let selectedProducts=new Set();
let searchResults=[];
let cartItems=new Set();
let currentMode='catalogs';

const CATEGORIES={
  'Relojes':{icon:'‚åö',keywords:['reloj','relojes']},
  'Calculadoras':{icon:'üßÆ',keywords:['calculadora']},
  'Encendedores':{icon:'üî•',keywords:['zippo','encendedor']},
  'Accesorios':{icon:'ü™¢',keywords:['correa','correas']},
  'Joyas':{icon:'üíé',keywords:['joya','estuche','plata']},
  'Otros':{icon:'üì¶',keywords:[]}
};

function getCategoryForCatalog(n){
  const name=n.toLowerCase();
  for(const[category,config]of Object.entries(CATEGORIES)){
    if(config.keywords.some(k=>name.includes(k)))return category;
  }
  return'Otros';
}

function openDB(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('products'))db.createObjectStore('products',{keyPath:'Default_code'});
      if(!db.objectStoreNames.contains('meta'))db.createObjectStore('meta',{keyPath:'key'});
    };
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

async function saveProducts(p){
  const db=await openDB();
  const tx=db.transaction(['products','meta'],'readwrite');
  const store=tx.objectStore('products');
  await store.clear();
  p.forEach(i=>store.put(i));
  const meta=tx.objectStore('meta');
  await meta.put({key:'last_sync',value:Date.now()});
  await meta.put({key:'product_count',value:p.length});
  return new Promise((res,rej)=>{
    tx.oncomplete=res;
    tx.onerror=()=>rej(tx.error);
  });
}

async function loadProducts(){
  const db=await openDB();
  const tx=db.transaction('products','readonly');
  const req=tx.objectStore('products').getAll();
  return new Promise((res,rej)=>{
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

async function getLastSync(){
  const db=await openDB();
  const tx=db.transaction('meta','readonly');
  const req=tx.objectStore('meta').get('last_sync');
  return new Promise(res=>{
    req.onsuccess=()=>res(req.result?.value||0);
    req.onerror=()=>res(0);
  });
}

function updateLastSyncDisplay(ts){
  const el=document.getElementById('last-update-display');
  if(!ts){el.textContent='√öltima actualizaci√≥n: --';return;}
  const d=new Date(ts);
  const now=new Date();
  const diff=now-d;
  const hours=Math.floor(diff/3600000);
  const days=Math.floor(hours/24);
  let txt;
  if(days>0)txt=`Hace ${days} d√≠a${days>1?'s':''}`;
  else if(hours>0)txt=`Hace ${hours} hora${hours>1?'s':''}`;
  else txt='Reci√©n actualizado';
  el.textContent=`√öltima actualizaci√≥n: ${txt}`;
}

async function fetchProducts(){
  setSyncStatus('Sincronizando...');
  try{
    const res=await fetch(API_URL);
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    const data=await res.json();
    if(!Array.isArray(data))throw new Error('Invalid response');
    const inStock=data.filter(p=>(p.Stock||0)>0);
    await saveProducts(inStock);
    allProducts=inStock;
    setSyncStatus('Actualizado');
    showToast(`‚úì ${inStock.length} productos sincronizados`);
    updateLastSyncDisplay(Date.now());
    return true;
  }catch(err){
    console.error('Sync error:',err);
    setSyncStatus('Offline');
    return false;
  }
}

async function forceUpdate(){
  if(!navigator.onLine){
    showToast('Sin conexi√≥n a internet');
    return;
  }
  showToast('Actualizando...');
  await fetchCaracteristicas();
  const success=await fetchProducts();
  if(success){
    buildCatalogs();
    showToast('‚úì Todo actualizado');
  }else{
    showToast('Error al actualizar');
  }
}

async function fetchCaracteristicas(){
  try{
    const res=await fetch(CARACT_URL);
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    caracteristicas=await res.json();
    console.log(`Caracter√≠sticas cargadas: ${Object.keys(caracteristicas).length}`);
  }catch(err){
    console.error('Error cargando caracter√≠sticas:',err);
  }
}

function setSyncStatus(l){
  document.getElementById('sync-label').textContent=l;
  document.getElementById('sync-label-welcome').textContent=l;
}

function buildCatalogs(){
  catalogs={};
  catalogsByCategory={};
  allProducts.forEach(p=>{
    const parent=p.Parent_category||'Otros';
    const category=p.Category||'';
    let catName;
    if(parent.toLowerCase().includes('reloj')||parent.toLowerCase().includes('calculadora')){
      catName=category?`${parent} ${category}`:parent;
    }else{
      catName=parent;
    }
    if(!catalogs[catName])catalogs[catName]={name:catName,products:[]};
    catalogs[catName].products.push(p);
  });
  for(const cat of Object.values(catalogs)){
    const categoryName=getCategoryForCatalog(cat.name);
    if(!catalogsByCategory[categoryName])catalogsByCategory[categoryName]=[];
    catalogsByCategory[categoryName].push(cat);
  }
  catalogList=Object.keys(catalogs).sort();
  renderCatalogList();
  updateStats();
}

function updateStats(){
  const catCount=Object.keys(catalogs).length;
  const prodCount=allProducts.length;
  document.getElementById('total-catalogs').textContent=catCount;
  document.getElementById('total-products').textContent=prodCount;
  document.getElementById('total-catalogs-welcome').textContent=catCount;
  document.getElementById('total-products-welcome').textContent=prodCount;
}

function toggleCategory(n){
  const el=document.getElementById(`cat-${n}`);
  if(el)el.classList.toggle('open');
}

function renderCatalogList(){
  const content=document.getElementById('home-content-inner');
  if(Object.keys(catalogsByCategory).length===0){
    content.innerHTML='<div class="loading-state"><div>Sin cat√°logos</div></div>';
    return;
  }
  let html='';
  for(const[categoryName,cats]of Object.entries(catalogsByCategory)){
    const config=CATEGORIES[categoryName];
    const catId=`cat-${categoryName}`;
    html+=`<div class="category-accordion" id="${catId}">
      <div class="category-header" onclick="toggleCategory('${categoryName}')">
        <div class="category-left">
          <div class="category-icon">${config.icon}</div>
          <div class="category-title">${categoryName}</div>
        </div>
        <div class="category-count">${cats.length}</div>
        <div class="chevron-icon">‚Ä∫</div>
      </div>
      <div class="category-content"><div class="catalog-list">`;
    cats.forEach(cat=>{
      html+=`<div class="catalog-item">
        <div class="catalog-info" onclick="openCatalog('${encodeURIComponent(cat.name)}')">
          <div class="catalog-name">${cat.name}</div>
          <div class="catalog-meta">${cat.products.length} productos</div>
        </div>
      </div>`;
    });
    html+=`</div></div></div>`;
  }
  content.innerHTML=html;
}

// SEARCH
let searchTimeout;
function performSearch(){
  clearTimeout(searchTimeout);
  const query=document.getElementById('search-input').value.trim();
  if(!query){
    document.getElementById('search-results').innerHTML='<div class="loading-state"><div style="font-size:48px;margin-bottom:12px">üîç</div><div>Escribe un c√≥digo o nombre para buscar</div></div>';
    searchResults=[];
    return;
  }
  
  // Mostrar indicador de b√∫squeda
  document.getElementById('search-results').innerHTML='<div class="loading-state"><div class="spinner"></div><div>Buscando...</div></div>';
  
  searchTimeout=setTimeout(()=>{
    executeSearch();
  },300);
}

function executeSearch(){
  const query=document.getElementById('search-input').value.trim().toUpperCase();
  if(!query){
    document.getElementById('search-results').innerHTML='<div class="loading-state"><div style="font-size:48px;margin-bottom:12px">üîç</div><div>Escribe un c√≥digo o nombre para buscar</div></div>';
    searchResults=[];
    return;
  }
  
  let results=allProducts.filter(p=>{
    const code=(p.Default_code||'').toUpperCase();
    const name=(p.Name||'').toUpperCase();
    return code.includes(query)||name.includes(query);
  });
  
  if(activeFilters.generos.length>0){
    results=results.filter(p=>{
      const c=caracteristicas[p.Default_code];
      return c&&activeFilters.generos.includes(c.genero);
    });
  }
  if(activeFilters.colores.length>0){
    results=results.filter(p=>{
      const c=caracteristicas[p.Default_code];
      return c&&activeFilters.colores.includes(c.color);
    });
  }
  if(activeFilters.tamanos.length>0){
    results=results.filter(p=>{
      const c=caracteristicas[p.Default_code];
      return c&&activeFilters.tamanos.includes(c.tamano_esfera);
    });
  }
  if(activeFilters.resistencias.length>0){
    results=results.filter(p=>{
      const c=caracteristicas[p.Default_code];
      return c&&activeFilters.resistencias.includes(c.resistencia_agua);
    });
  }
  if(activeFilters.familias.length>0){
    results=results.filter(p=>{
      const parent=p.Parent_category||'Otros';
      return activeFilters.familias.some(f=>parent.includes(f));
    });
  }
  
  searchResults=results;
  renderSearchResults(results);
}

function renderSearchResults(products){
  const container=document.getElementById('search-results');
  if(products.length===0){
    container.innerHTML='<div class="loading-state"><div style="font-size:48px;margin-bottom:12px">‚ùå</div><div>No se encontraron productos</div></div>';
    return;
  }
  
  const byFamily={};
  products.forEach(p=>{
    const family=p.Parent_category||'Otros';
    if(!byFamily[family])byFamily[family]=[];
    byFamily[family].push(p);
  });
  
  let html='';
  Object.entries(byFamily).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([family,prods])=>{
    const familySkus=prods.map(p=>p.Default_code);
    const allInCart=familySkus.every(sku=>cartItems.has(sku));
    const someInCart=familySkus.some(sku=>cartItems.has(sku));
    const inCartCount=familySkus.filter(sku=>cartItems.has(sku)).length;
    
    html+=`<div class="family-group">
      <div class="family-header">
        <div class="family-title">${family} (${prods.length}${someInCart?' ¬∑ '+inCartCount+' en canasta':''})</div>
        <button class="add-all-btn" onclick="${allInCart?`removeAllFromFamily('${family}')`:`addAllToFamily('${family}')`}">
          ${allInCart?'‚úì Todos':'+ Agregar todos'}
        </button>
      </div>
      <div class="product-list">`;
    prods.forEach(p=>{
      const checked=cartItems.has(p.Default_code)?'checked':'';
      const price=formatPrice(p.Price||0);
      const inCartBadge=cartItems.has(p.Default_code)?'<span style="background:#27ae60;color:white;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;margin-left:4px">‚úì</span>':'';
      html+=`<div class="product-item" style="${cartItems.has(p.Default_code)?'background:#e8f5e9;border:1px solid #c8e6c9':''}">
        <input type="checkbox" class="product-checkbox" ${checked} onchange="toggleCart('${p.Default_code}')">
        <div class="product-item-img">üì¶</div>
        <div class="product-info">
          <div class="product-code">${p.Default_code}${inCartBadge}</div>
          <div class="product-name">${p.Name||'Sin nombre'}</div>
        </div>
        <div class="product-price">${price}</div>
      </div>`;
    });
    html+=`</div></div>`;
  });
  
  container.innerHTML=html;
}

function addAllToFamily(family){
  const familyProducts=searchResults.filter(p=>(p.Parent_category||'Otros')===family);
  familyProducts.forEach(p=>cartItems.add(p.Default_code));
  saveCartToStorage();
  updateCartButton();
  renderSearchResults(searchResults);
  showToast(`‚úì ${familyProducts.length} productos agregados`);
}

function removeAllFromFamily(family){
  const familyProducts=searchResults.filter(p=>(p.Parent_category||'Otros')===family);
  familyProducts.forEach(p=>cartItems.delete(p.Default_code));
  saveCartToStorage();
  updateCartButton();
  renderSearchResults(searchResults);
  showToast(`‚úì ${familyProducts.length} productos removidos`);
}

function toggleCart(sku){
  if(cartItems.has(sku)){
    cartItems.delete(sku);
  }else{
    cartItems.add(sku);
    // Animaci√≥n pulse
    const btn=document.getElementById('cart-btn');
    btn.classList.add('pulse');
    setTimeout(()=>btn.classList.remove('pulse'),300);
  }
  saveCartToStorage();
  updateCartButton();
  if(currentMode==='search')renderSearchResults(searchResults);
}

function saveCartToStorage(){
  localStorage.setItem('cart_items',JSON.stringify([...cartItems]));
}

function loadCartFromStorage(){
  try{
    const saved=localStorage.getItem('cart_items');
    if(saved){
      const items=JSON.parse(saved);
      cartItems=new Set(items);
      updateCartButton();
    }
  }catch(err){
    console.error('Error loading cart:',err);
  }
}

function updateCartButton(){
  const btn=document.getElementById('cart-btn');
  const count=document.getElementById('cart-count');
  if(cartItems.size>0){
    btn.classList.add('show');
    count.textContent=`${cartItems.size} producto${cartItems.size>1?'s':''}`;
  }else{
    btn.classList.remove('show');
  }
}

function openCart(){
  const modal=document.getElementById('cart-modal');
  const itemsContainer=document.getElementById('cart-items');
  const nameInput=document.getElementById('custom-catalog-name');
  
  nameInput.value='';
  
  if(cartItems.size===0){
    itemsContainer.innerHTML='<div class="loading-state"><div style="padding:40px 20px">üõí<br><br>Canasta vac√≠a</div></div>';
    document.getElementById('generate-cart-pdf').disabled=true;
  }else{
    let totalPrice=0;
    let html='';
    cartItems.forEach(sku=>{
      const p=allProducts.find(prod=>prod.Default_code===sku);
      if(!p)return;
      const price=p.Price||0;
      totalPrice+=price;
      const priceFormatted=formatPrice(price);
      html+=`<div class="cart-item">
        <button class="remove-item" onclick="toggleCart('${sku}');openCart()">√ó</button>
        <div class="cart-item-img">üì¶</div>
        <div class="product-info" style="flex:1;min-width:0">
          <div class="product-code">${p.Default_code}</div>
          <div class="product-name">${p.Name||'Sin nombre'}</div>
        </div>
        <div class="product-price">${priceFormatted}</div>
      </div>`;
    });
    
    const totalFormatted=formatPrice(totalPrice);
    itemsContainer.innerHTML=`
      <div class="cart-summary">
        <span style="font-weight:600;color:#666">Total (sin IVA)</span>
        <span style="font-size:18px;font-weight:700;color:#333">${totalFormatted}</span>
      </div>
      <button class="clear-cart-btn" onclick="clearCart()">üóëÔ∏è Limpiar canasta</button>
      ${html}`;
    document.getElementById('generate-cart-pdf').disabled=false;
  }
  
  modal.classList.add('show');
}

function clearCart(){
  if(!confirm('¬øLimpiar toda la canasta?'))return;
  cartItems.clear();
  saveCartToStorage();
  updateCartButton();
  closeCart();
  if(currentMode==='search')performSearch();
}

function closeCart(){
  document.getElementById('cart-modal').classList.remove('show');
}

async function generateCartPDF(){
  const name=document.getElementById('custom-catalog-name').value.trim()||'Cat√°logo personalizado';
  if(cartItems.size===0){
    showToast('Canasta vac√≠a');
    return;
  }
  const products=allProducts.filter(p=>cartItems.has(p.Default_code));
  closeCart();
  showToast('Generando PDF...');
  try{
    await generatePDF(name,products);
    showToast('‚úì PDF descargado');
  }catch(err){
    console.error('PDF error:',err);
    showToast('Error al generar PDF');
  }
}

// FILTERS
function getAvailableFilters(products){
  const filters={generos:{},colores:{},tamanos:{},resistencias:{},familias:{}};
  products.forEach(p=>{
    const c=caracteristicas[p.Default_code];
    if(c){
      if(c.genero)filters.generos[c.genero]=(filters.generos[c.genero]||0)+1;
      if(c.color)filters.colores[c.color]=(filters.colores[c.color]||0)+1;
      if(c.tamano_esfera)filters.tamanos[c.tamano_esfera]=(filters.tamanos[c.tamano_esfera]||0)+1;
      if(c.resistencia_agua)filters.resistencias[c.resistencia_agua]=(filters.resistencias[c.resistencia_agua]||0)+1;
    }
    const family=p.Parent_category||'Otros';
    filters.familias[family]=(filters.familias[family]||0)+1;
  });
  return filters;
}

function renderFilters(){
  const products=currentMode==='search'?searchResults.length>0?searchResults:allProducts:currentCatalog?currentCatalog.products:[];
  const filters=getAvailableFilters(products);
  const content=document.getElementById('filters-content');
  let html='';
  
  if(currentMode==='search'&&Object.keys(filters.familias).length>0){
    html+=`<div class="filter-section"><div class="filter-section-title">Familia</div>`;
    Object.entries(filters.familias).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([f,count])=>{
      const checked=activeFilters.familias.includes(f)?'checked':'';
      html+=`<div class="filter-option">
        <input type="checkbox" id="fam-${f}" ${checked} onchange="toggleMultiFilter('familias','${f}')">
        <label for="fam-${f}">${f}</label>
        <span class="filter-option-count">(${count})</span>
      </div>`;
    });
    html+=`</div>`;
  }
  
  if(Object.keys(filters.generos).length>0){
    html+=`<div class="filter-section"><div class="filter-section-title">G√©nero</div>`;
    Object.entries(filters.generos).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([g,count])=>{
      const checked=activeFilters.generos.includes(g)?'checked':'';
      html+=`<div class="filter-option">
        <input type="checkbox" id="gen-${g}" ${checked} onchange="toggleMultiFilter('generos','${g}')">
        <label for="gen-${g}">${g}</label>
        <span class="filter-option-count">(${count})</span>
      </div>`;
    });
    html+=`</div>`;
  }
  
  if(Object.keys(filters.colores).length>0){
    html+=`<div class="filter-section"><div class="filter-section-title">Color</div>`;
    Object.entries(filters.colores).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([c,count])=>{
      const checked=activeFilters.colores.includes(c)?'checked':'';
      html+=`<div class="filter-option">
        <input type="checkbox" id="col-${c}" ${checked} onchange="toggleMultiFilter('colores','${c}')">
        <label for="col-${c}">${c}</label>
        <span class="filter-option-count">(${count})</span>
      </div>`;
    });
    html+=`</div>`;
  }
  
  if(Object.keys(filters.tamanos).length>0){
    html+=`<div class="filter-section"><div class="filter-section-title">Tama√±o esfera</div>`;
    Object.entries(filters.tamanos).sort((a,b)=>a[0]-b[0]).forEach(([t,count])=>{
      const checked=activeFilters.tamanos.includes(parseInt(t))?'checked':'';
      html+=`<div class="filter-option">
        <input type="checkbox" id="tam-${t}" ${checked} onchange="toggleMultiFilter('tamanos',${t})">
        <label for="tam-${t}">${t}mm</label>
        <span class="filter-option-count">(${count})</span>
      </div>`;
    });
    html+=`</div>`;
  }
  
  if(Object.keys(filters.resistencias).length>0){
    html+=`<div class="filter-section"><div class="filter-section-title">Resistencia al agua</div>`;
    Object.entries(filters.resistencias).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([r,count])=>{
      const checked=activeFilters.resistencias.includes(r)?'checked':'';
      html+=`<div class="filter-option">
        <input type="checkbox" id="res-${r}" ${checked} onchange="toggleMultiFilter('resistencias','${r}')">
        <label for="res-${r}">${r}</label>
        <span class="filter-option-count">(${count})</span>
      </div>`;
    });
    html+=`</div>`;
  }
  
  content.innerHTML=html;
}

function toggleFilters(){
  const sidebar=document.getElementById('filters-sidebar');
  const overlay=document.getElementById('filters-overlay');
  if(!sidebar.classList.contains('open')){
    renderFilters();
  }
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

function toggleMultiFilter(type,value){
  const idx=activeFilters[type].indexOf(value);
  if(idx>-1){
    activeFilters[type].splice(idx,1);
  }else{
    activeFilters[type].push(value);
  }
  if(currentMode==='catalogs'){
    applyFilters();
  }else{
    performSearch();
  }
  updateFilterCount();
}

function clearAllFilters(){
  activeFilters={generos:[],colores:[],tamanos:[],resistencias:[],familias:[]};
  if(currentMode==='catalogs'){
    applyFilters();
  }else{
    performSearch();
  }
  renderFilters();
  updateFilterCount();
}

function updateFilterCount(){
  const total=activeFilters.generos.length+activeFilters.colores.length+activeFilters.tamanos.length+activeFilters.resistencias.length+activeFilters.familias.length;
  const badge1=document.getElementById('filter-count');
  const badge2=document.getElementById('search-filter-count');
  if(total>0){
    if(badge1){badge1.textContent=total;badge1.style.display='inline-block';}
    if(badge2){badge2.textContent=total;badge2.style.display='inline-block';}
  }else{
    if(badge1)badge1.style.display='none';
    if(badge2)badge2.style.display='none';
  }
}

function navigateCatalog(direction){
  const newIndex=currentCatalogIndex+direction;
  if(newIndex<0||newIndex>=catalogList.length)return;
  const newCatalogName=catalogList[newIndex];
  openCatalog(encodeURIComponent(newCatalogName));
}

function updateProductCount(){
  const total=currentCatalog.products.length;
  const showing=filteredProducts.length;
  const label=document.getElementById('product-count-label');
  if(showing<total){
    label.textContent=`Mostrando ${showing} de ${total} productos`;
  }else{
    label.textContent=`${total} productos`;
  }
}

function applyFilters(){
  if(!currentCatalog)return;
  let filtered=currentCatalog.products;
  
  if(activeFilters.generos.length>0){
    filtered=filtered.filter(p=>{
      const c=caracteristicas[p.Default_code];
      return c&&activeFilters.generos.includes(c.genero);
    });
  }
  if(activeFilters.colores.length>0){
    filtered=filtered.filter(p=>{
      const c=caracteristicas[p.Default_code];
      return c&&activeFilters.colores.includes(c.color);
    });
  }
  if(activeFilters.tamanos.length>0){
    filtered=filtered.filter(p=>{
      const c=caracteristicas[p.Default_code];
      return c&&activeFilters.tamanos.includes(c.tamano_esfera);
    });
  }
  if(activeFilters.resistencias.length>0){
    filtered=filtered.filter(p=>{
      const c=caracteristicas[p.Default_code];
      return c&&activeFilters.resistencias.includes(c.resistencia_agua);
    });
  }
  
  filteredProducts=filtered;
  updateProductCount();
  renderCatalogProducts(filtered);
}

function openCatalog(n){
  const name=decodeURIComponent(n);
  currentCatalog=catalogs[name];
  if(!currentCatalog)return;
  currentCatalogIndex=catalogList.indexOf(name);
  currentMode='catalogs';
  activeFilters={generos:[],colores:[],tamanos:[],resistencias:[],familias:[]};
  selectedProducts.clear();
  filteredProducts=currentCatalog.products;
  document.getElementById('pdf-title-header').textContent=name;
  document.getElementById('breadcrumb-catalog').textContent=name;
  updateProductCount();
  updateFilterCount();
  renderCatalogProducts(currentCatalog.products);
  showScreen('pdf-viewer');
}

function renderCatalogProducts(products){
  const today=new Date().toLocaleDateString('es-CL',{day:'2-digit',month:'2-digit',year:'numeric'});
  const photoBase=localStorage.getItem('photo_base_url')||'';
  let html=`
    <div class="pdf-page-header">
      <div class="pdf-header-left">
        <div class="contact-info">
          <div class="contact-item">üìû 9 6292 9654</div>
          <div class="contact-item">‚úâÔ∏è ventas@temponovo.cl</div>
        </div>
        <div class="contact-info">
          <div class="contact-item">üìû 2 2229 3138</div>
          <div class="contact-item">üìç Las Carmelitas 51, Las Condes</div>
        </div>
      </div>
      <img src="https://www.temponovo.cl/asset/img/temponovo-logo-color.svg" class="pdf-page-logo">
    </div>
    <div class="pdf-page-title-bar">
      <div class="pdf-page-title">${currentCatalog.name}</div>
      <div class="pdf-page-date">${today}</div>
    </div>`;
  
  if(selectedProducts.size>0){
    html+=`<div style="background:#27ae60;color:white;padding:12px 20px;display:flex;align-items:center;justify-content:space-between">
      <span>${selectedProducts.size} producto${selectedProducts.size>1?'s':''} seleccionado${selectedProducts.size>1?'s':''}</span>
      <button onclick="generateSelectedPDF()" style="background:white;color:#27ae60;border:none;padding:8px 16px;border-radius:6px;font-weight:600;cursor:pointer">Generar PDF</button>
    </div>`;
  }
  
  html+=`<div class="pdf-products">`;
  products.forEach(p=>{
    const price=formatPrice(p.Price||0);
    const stock=p.Stock||0;
    const stockDisplay=stock>100?'100+':stock;
    let stockClass='high';
    if(stock<10)stockClass='low';
    else if(stock<15)stockClass='medium';
    const imgTag=photoBase?`<img src="${photoBase}/${p.Default_code}.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt="${p.Name}">`:'';
    const caract=caracteristicas[p.Default_code];
    let featuresHtml='';
    if(caract){
      featuresHtml='<div class="product-features">';
      if(caract.genero)featuresHtml+=`<div class="feature-item"><span class="feature-label">G√©nero:</span> <span class="feature-value">${caract.genero}</span></div>`;
      if(caract.color)featuresHtml+=`<div class="feature-item"><span class="feature-label">Color:</span> <span class="feature-value">${caract.color}</span></div>`;
      if(caract.tamano_esfera)featuresHtml+=`<div class="feature-item"><span class="feature-label">Tama√±o:</span> <span class="feature-value">${caract.tamano_esfera}mm</span></div>`;
      if(caract.resistencia_agua)featuresHtml+=`<div class="feature-item"><span class="feature-label">Resist:</span> <span class="feature-value">${caract.resistencia_agua}</span></div>`;
      featuresHtml+='</div>';
    }
    const isSelected=selectedProducts.has(p.Default_code);
    html+=`
      <div class="pdf-product" style="position:relative">
        <input type="checkbox" ${isSelected?'checked':''} onchange="toggleProductSelection('${p.Default_code}')" 
               style="position:absolute;top:10px;left:10px;width:20px;height:20px;cursor:pointer;z-index:10;accent-color:#27ae60">
        <div class="pdf-product-img-wrap">
          ${imgTag}
          <div class="emoji" style="${imgTag?'display:none':'display:flex'}">üì¶</div>
          <div class="stock-corner ${stockClass}">${stockDisplay}</div>
        </div>
        <div class="pdf-product-info">
          <div class="pdf-product-code">${p.Default_code||''}</div>
          <div class="pdf-product-name">${p.Name||'Sin nombre'}</div>
          <div class="pdf-product-price">${price} <span>+ IVA</span></div>
          ${featuresHtml}
        </div>
      </div>`;
  });
  html+=`</div>
    <div class="pdf-footer">
      üìû 9 6292 9654 ¬∑ 2 2229 3138 | ‚úâÔ∏è ventas@temponovo.cl | üìç Las Carmelitas 51, Las Condes<br>
      Actualizado: ${today}
    </div>`;
  document.getElementById('pdf-content').innerHTML=html;
}

function toggleProductSelection(sku){
  if(selectedProducts.has(sku)){
    selectedProducts.delete(sku);
  }else{
    selectedProducts.add(sku);
  }
  renderCatalogProducts(filteredProducts);
}

async function generateSelectedPDF(){
  if(selectedProducts.size===0){
    showToast('Selecciona al menos un producto');
    return;
  }
  const selectedList=filteredProducts.filter(p=>selectedProducts.has(p.Default_code));
  showToast('Generando PDF...');
  try{
    await generatePDF(currentCatalog.name+' (Selecci√≥n)',selectedList);
    showToast('‚úì PDF descargado');
  }catch(err){
    console.error('PDF error:',err);
    showToast('Error al generar PDF');
  }
}

function formatPrice(p){
  if(!p)return'$0';
  return'$'+Math.round(p).toLocaleString('es-CL');
}

async function generatePDF(catName,products){
  const{jsPDF}=window.jspdf;
  const tempDiv=document.createElement('div');
  tempDiv.style.position='absolute';
  tempDiv.style.left='-9999px';
  tempDiv.className='pdf-page';
  const today=new Date().toLocaleDateString('es-CL',{day:'2-digit',month:'2-digit',year:'numeric'});
  let html=`
    <div class="pdf-page-header">
      <div class="pdf-header-left">
        <div class="contact-info">
          <div class="contact-item">üìû 9 6292 9654</div>
          <div class="contact-item">‚úâÔ∏è ventas@temponovo.cl</div>
        </div>
      </div>
      <img src="https://www.temponovo.cl/asset/img/temponovo-logo-color.svg" class="pdf-page-logo">
    </div>
    <div class="pdf-page-title-bar">
      <div class="pdf-page-title">${catName}</div>
      <div class="pdf-page-date">${today}</div>
    </div>
    <div class="pdf-products">`;
  products.forEach(p=>{
    const price=formatPrice(p.Price||0);
    const stock=p.Stock||0;
    const stockDisplay=stock>100?'100+':stock;
    let stockClass=stock<10?'low':stock<15?'medium':'high';
    html+=`
      <div class="pdf-product">
        <div class="pdf-product-img-wrap">
          <div class="emoji">üì¶</div>
          <div class="stock-corner ${stockClass}">${stockDisplay}</div>
        </div>
        <div class="pdf-product-info">
          <div class="pdf-product-code">${p.Default_code||''}</div>
          <div class="pdf-product-name">${p.Name||'Sin nombre'}</div>
          <div class="pdf-product-price">${price} <span>+ IVA</span></div>
        </div>
      </div>`;
  });
  html+=`</div>`;
  tempDiv.innerHTML=html;
  document.body.appendChild(tempDiv);
  const canvas=await html2canvas(tempDiv,{scale:1.5,logging:false});
  const imgData=canvas.toDataURL('image/jpeg',0.9);
  const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const imgWidth=210;
  const imgHeight=(canvas.height*imgWidth)/canvas.width;
  pdf.addImage(imgData,'JPEG',0,0,imgWidth,imgHeight);
  const filename=`${catName.replace(/[^a-z0-9]/gi,'_')}.pdf`;
  pdf.save(filename);
  document.body.removeChild(tempDiv);
}

async function shareCatalogPDF(){
  if(!currentCatalog)return;
  showToast('Generando PDF...');
  try{
    await generatePDF(currentCatalog.name,filteredProducts);
    showToast('‚úì PDF descargado');
  }catch(err){
    console.error('PDF error:',err);
    showToast('Error al generar PDF');
  }
}

async function downloadAllCatalogs(){
  if(Object.keys(catalogs).length===0){
    showToast('No hay cat√°logos disponibles');
    return;
  }
  showToast(`Generando ${Object.keys(catalogs).length} PDFs...`);
  let completed=0;
  for(const[catName,catalog]of Object.entries(catalogs)){
    try{
      await generatePDF(catName,catalog.products);
      completed++;
      await new Promise(res=>setTimeout(res,500));
    }catch(err){
      console.error(`Error generando ${catName}:`,err);
    }
  }
  showToast(`‚úì ${completed} PDFs descargados`);
}

function showAdminPanel(){
  const url=prompt('URL base de fotos en Google Drive:',localStorage.getItem('photo_base_url')||'');
  if(url!==null){
    localStorage.setItem('photo_base_url',url.trim());
    showToast('‚úì URL de fotos guardada');
    if(currentCatalog){
      openCatalog(encodeURIComponent(currentCatalog.name));
    }
  }
}

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

function goToWelcome(){
  activeFilters={generos:[],colores:[],tamanos:[],resistencias:[],familias:[]};
  updateFilterCount();
  showScreen('welcome');
}

function goToCatalogs(){
  currentMode='catalogs';
  showScreen('home');
}

function goToSearch(){
  currentMode='search';
  activeFilters={generos:[],colores:[],tamanos:[],resistencias:[],familias:[]};
  document.getElementById('search-input').value='';
  updateFilterCount();
  showScreen('search');
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}

async function init(){
  loadCartFromStorage();
  await fetchCaracteristicas();
  allProducts=await loadProducts();
  if(allProducts.length>0){
    buildCatalogs();
    setSyncStatus('Offline');
    const lastSync=await getLastSync();
    updateLastSyncDisplay(lastSync);
  }
  const lastSync=await getLastSync();
  const needsUpdate=Date.now()-lastSync>UPDATE_INTERVAL;
  if(navigator.onLine&&(needsUpdate||allProducts.length===0)){
    const success=await fetchProducts();
    if(success)buildCatalogs();
  }
  window.addEventListener('online',async()=>{
    showToast('Conexi√≥n restaurada');
    await fetchProducts();
    buildCatalogs();
  });
}

init();
</script>
</body>
</html>
